<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard</title>
    <style>
        img {
            height: 50px;
            width: 50px;

        }
    </style>
</head>

<body>
    <h1>Search for a City:</h1>

    <!-- this form is used to get the user input -->
    <form id="city-form">
        <label for="city-input">Search for a City:</label>
        <input type="text" id="city-input"><br>

        <!-- this button will trigger our AJAX call -->
        <input id="find-city" type="submit" value="City Search">
    </form>
    <div class="search-history"></div>

    <!-- Weather data placeholders -->
    <h1 class="city-date"></h1>
    <div class="temperature"></div>
    <div class="humidity"></div>
    <div class="wind-speed"></div>
    <div class="uv-index"></div>
    <div class="forecast"></div>

    <!-- jQuery library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script type="text/javascript">
        $("#find-city").on("click", createWeatherData);
        // this function is called either by the click on the search button or when the page is refreshed and there is something in local storage
        function createWeatherData() {
            // get userInputCity
            if (localStorage.length !== 0 && !$("#city-input").val()) {
                var userInputCity = localStorage.getItem(localStorage.length - 1);
            } else {
                // Preventing the submit button from trying to submit the form
                // We're optionally using a form so the user may hit Enter to search instead of clicking the button
                event.preventDefault();
                var userInputCity = $("#city-input").val().toLowerCase().trim();
            }
            // if an empty input is submitted, break out of this function
            if (userInputCity === "") {
                return;
            }
            // store the city in local storage if not already stored
            let localStorageBool = false;
            if (localStorage.length === 0) {
                localStorage.setItem(0, userInputCity);
                createSearchHistory();
                localStorageBool = true;
            } else {
                for (let i = 0; i < localStorage.length; i++) {
                    if (localStorage.getItem(i) === userInputCity) {
                        localStorageBool = true;
                    }
                }
            }
            if (!localStorageBool) {
                localStorage.setItem(localStorage.length, userInputCity);
                createSearchHistory();
            }
            // OpenWeatherApp API key 
            let APIKey = "870109d2706d7781ec3e7e2c0c95b193";
            // Build the URL for the AJAX call
            let queryURL = "https://api.openweathermap.org/data/2.5/weather?q=" + userInputCity + "&appid=" +
                APIKey;
            console.log(queryURL + " query url");
            // AJAX call for current weather data
            $.ajax({
                url: queryURL,
                method: "GET"
            }).then(function (response) {
                // check the response
                console.log(response);
                // get current date. the response returns the date and time in unix. these next couple lines of code convert it to a standard format
                let currentDateUnix = response.dt;
                let currentDateMilliseconds = currentDateUnix * 1000;
                let currentDateConverted = new Date(currentDateMilliseconds).toLocaleDateString(
                    "en-US");
                // get icon
                let currentWeatherIcon = response.weather[0].icon;
                // get current temperature. the response returns temperature in Kelvin. Kelvin to Fahrenheit: F = (K - 273.15) * 1.80 + 32
                let tempF = ((response.main.temp - 273.15) * 1.80 + 32).toFixed(1);
                // get lat and lon coordinates for the second AJAX call for the uv index and forecast 
                let lat = response.coord.lat;
                let lon = response.coord.lon;

                // attach info to html
                $(".city-date").text(response.name + " (" + currentDateConverted + ")");
                $(".city-date")
                    .append($("<img>").attr("src", "http://openweathermap.org/img/wn/" +
                        currentWeatherIcon +
                        "@2x.png"));
                $(".temperature").text("Temperature " +
                    tempF + "\u00B0F");
                $(".humidity").text("Humidity: " + response.main.humidity + "%");
                // the response returns wind speed in meters/second. convert meters/second to miles/hour with 2.237
                $(".wind-speed").text("Wind Speed: " + ((response.wind.speed) * 2.237).toFixed(1) +
                    " MPH");

                // build the URL for the second AJAX call
                let forecastQueryURL = "https://api.openweathermap.org/data/2.5/onecall?lat=" + lat +
                    "&lon=" + lon + "&exclude=current,minutely,hourly&appid=" + APIKey;
                // make second AJAX call for the uv index and 5 day weather forecast
                $.ajax({
                    url: forecastQueryURL,
                    method: "GET"
                }).then(function (responseForecast) {
                    // check the response
                    console.log(responseForecast);
                    // get the uv index 
                    $(".uv-index").text("UV Index: " + responseForecast.daily[0].uvi);
                    // clear current forecast information before adding new information 
                    $(".forecast").empty();
                    for (let i = 1; i < 6; i++) {
                        // get date and append
                        $(".forecast").append(new Date(responseForecast.daily[i].dt *
                                1000)
                            .toLocaleDateString("en-US") + "<br>");
                        // get icon and append
                        $(".forecast").append($("<img>").attr("src",
                            "http://openweathermap.org/img/wn/" + responseForecast
                            .daily[i].weather[0].icon +
                            "@2x.png"));
                        // get temperature and append
                        $(".forecast").append("<br>Temp: " + ((responseForecast.daily[i].temp
                                .day - 273.15) *
                            1.80 + 32).toFixed(1) + " \u00B0F<br>");
                        // get humidity and append
                        $(".forecast").append("Humidity: " + responseForecast.daily[i]
                            .humidity + "%<br>");
                    }
                });
            });
            console.log($("#city-input").val());
            $("#city-input").val("");
        }
        // create search history list from local storage
        function createSearchHistory() {
            $(".search-history").empty();
            for (let i = 0; i < localStorage.length; i++) {
                $(".search-history").append(localStorage.getItem(i) + " <br>");
            }
        }
        // if the page is refreshed, render the search history and weather data for the last item in local storage if local storage is not empty 
        if (localStorage.length !== 0) {
            createSearchHistory();
            createWeatherData();
        }
    </script>
</body>

</html>