<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard</title>
</head>

<body>
    <h1>Search for a City:</h1>

    <!-- this form is used to get the user input -->
    <form id="city-form">
        <label for="city-input">Search for a city</label>
        <input type="text" id="city-input"><br>

        <!-- this button will trigger our AJAX call -->
        <input id="find-city" type="submit" value="City Search">
    </form>

    <!-- Weather data placeholders -->
    <h1 class="city-date"></h1>
    <div class="temperature"></div>
    <div class="humidity"></div>
    <div class="wind-speed"></div>
    <div class="uv-index"></div>
    <img class="icon"></>
    <div class="unix-converted"></div>



    <!-- jQuery library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- https://momentjs.com/ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>

    <script type="text/javascript">
        $("#find-city").on("click", function (event) {
            // Preventing the submit button from trying to submit the form
            // We're optionally using a form so the user may hit Enter to search instead of clicking the button
            event.preventDefault();

            // get userInputCity
            let userInputCity = $("#city-input").val();
            // OpenWeatherApp API key 
            let APIKey = "870109d2706d7781ec3e7e2c0c95b193";

            // Build the URL for the ajax call
            let queryURL = "https://api.openweathermap.org/data/2.5/weather?q=" + userInputCity + "&appid=" +
                APIKey;
            console.log(queryURL + " query url");
            // AJAX call for current weather data
            $.ajax({
                url: queryURL,
                method: "GET"
            }).then(function (response) {
                // check the response
                console.log(response + " current weather data");
                // Kelvin to Fahrenheit: F = (K - 273.15) * 1.80 + 32
                let tempF = ((response.main.temp - 273.15) * 1.80 + 32).toFixed(1);
                // get lat and lon coordinates for the uv index 
                let lat = response.coord.lat;
                let lon = response.coord.lon;

                // build the URL for the second ajax call for the UV index using the lat and lon coordinates of the user input city
                let UVIndexQueryURL = "https://api.openweathermap.org/data/2.5/uvi?lat=" + lat +
                    "&lon=" + lon + "&appid=" + APIKey;

                // make another AJAX call for the UV index
                $.ajax({
                    url: UVIndexQueryURL,
                    method: "GET"
                }).then(function (responseUV) {
                    // check the response
                    console.log(responseUV + " uv data");
                    // attach uvIndex to html 
                    $(".uv-index").text("UV Index: " + responseUV.value);
                });

                // build the URL for the third ajax call for the 5 day weather forecast
                let forecastQueryURL = "https://api.openweathermap.org/data/2.5/onecall?lat=" + lat +
                    "&lon=" + lon + "&exclude=current,minutely,hourly&appid=" + APIKey;
                // make another AJAX call for the 5 day weather forecast
                $.ajax({
                    url: forecastQueryURL,
                    method: "GET"
                }).then(function (responseForecast) {
                    // check the response
                    console.log(responseForecast);
                    let icon = responseForecast.daily[1].weather[0].icon;
                    $(".icon").attr("src", "http://openweathermap.org/img/wn/" + icon +
                        "@2x.png");
                    for (let i = 1; i < 6; i++) {
                        // the response returns the date and time in unix. these next couple lines of code convert it to a standard format
                        let dateUnix = responseForecast.daily[i].dt * 1000;
                        let newDate = new Date(dateUnix).toLocaleDateString("en-US");
                        console.log(newDate + " new date");
                        $(".unix-converted").append(newDate + " ");
                    }

                })

                // attach info to html
                $(".city-date").text(response.name + " (" + (moment().format(
                    "MMMM Do YYYY") + ")"));
                $(".temperature").text("Temperature " +
                    tempF + "\u00B0F");
                $(".humidity").text("Humidity: " + response.main.humidity + "%");
                // convert meters/second to miles/hour with 2.237
                $(".wind-speed").text("Wind speed: " + ((response.wind.speed) * 2.237).toFixed(1) +
                    " MPH");
            });

        });
    </script>
</body>

</html>